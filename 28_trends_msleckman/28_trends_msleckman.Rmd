---
title: "28 Trends - How much Water is entering Lake Tahoe?"
author: "Margaux Sleckman"
date: "2023-03-10"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## currently empty
source('src/funs.R')


```

```{r libraries,include=FALSE, warning=FALSE, message=FALSE}
# Load libraries
library(tidyverse) # includes ggplot
library(readr) # best for reading and writing csvs
library(lubridate)
library(glue)
library(zoo)
library(sf)
library(mapdata)
library(maps)
library(purrr)
library(spData)
library(ggspatial)
library(ggrepel)
library(colorfindr)

library(nhdplusTools)
library(dataRetrieval)

# These are used for the layout of the viz
library(cowplot) # for laying out the final plot
library(sysfonts) # for text editing
library(showtext) # for adding in google fonts
library(magick) # for adding logo
library(mapview) # for interactive map viz

```

```{r options_dir_creation, include=FALSE, warning=FALSE, message=FALSE}

options(tidyverse.quiet = TRUE, timeout = 500)
mapviewOptions(fgb = FALSE)

## Creating local folders for add
dir.create('in/R', showWarnings = F)
dir.create('in/R/nhdPlusTools', showWarnings = F)

```


## A. Workflow for Map 
### 1. Fetching nhdplus spatial data w/ nhdplustools
_code hidden_
```{r generic_nhdPlus_data_fetch, include=FALSE, warning=FALSE, message=FALSE}

# state boundaries --------------------------------------------------------

CA_sf <- us_states |> filter(NAME == 'California')
West_sf <- us_states |> filter(NAME %in% c('California','Oregon',
                                           'Nevada','Utah',
                                           'Arizona',
                                           'Idaho','Washington'))

# AOI for NHD data extraction ---------------------------------------------

## grab huc 8s with nhdplus tools
CA_huc8 <- nhdplusTools::get_huc8(AOI = CA_sf)

## define all huc4 to allow data download
CA_huc4 <- CA_huc8$huc8 |> substr(1,4) |> unique()

# NHD Data Download (conditional Run only if not downloaded yet) ----------------------------------

if(is.null(list.files('in/R/nhdPlusTools'))){
  
  print(paste('Downloading NHD data for the following CA HUC4s',CA_huc4))

  download_nhdplushr('in/', CA_huc4)
}

huc_gpkg_path <- 'in/R/nhdPlusTools/nhdplustools_HU_CA_data.gpkg'
wtbdy_gpkg_path <- 'in/R/nhdPlusTools/nhdplustools_CA_wtrbdy_data.gpkg'

if(is.null(list.files('in/R/nhdPlusTools', full.names = T, pattern = '_data.gpkg'))){
  # Store HUCs shps into geopackage
  print(paste('... Storing HUCs shps into a local geopackage here:', huc_gpkg_path))
  nhdplusTools::get_nhdplushr(hr_dir = 'in/R/nhdPlusTools/',
                              out_gpkg = huc_gpkg_path,
                              layer = c('WBDHU6','WBDHU8', 'WBDHU10'))

  # Store Waterbodies shps into geopackage
  print(paste('... Storing Waterbody shps into a local geopackage here:', wtbdy_gpkg_path))
  nhdplusTools::get_nhdplushr(hr_dir = 'in/R/nhdPlusTools/',
                              out_gpkg = 'in/R/nhdplustools_CA_wtrbdy_data.gpkg',
                              layer = 'NHDWaterbody')

  # # Store Waterbodies shps into geopackage
  # # This one takes A-WHILE so defaulted to using nhdplustools::get_flines()
  # nhdplusTools::get_nhdplushr(hr_dir = 'in/R/nhdPlusTools/',
  #                            out_gpkg = 'in/R/nhdplustools_CA_flines_data.gpkg',
  #                            layer = 'NHDFlowline')

  }
  
## Display Layers
print(st_layers(huc_gpkg_path))
print(st_layers(wtbdy_gpkg_path))

# Load nhdPlus features for AOI ----------------------------------------------------------------
## HUCS
huc10_CA <- st_read(huc_gpkg_path, layer = 'WBDHU10')
huc8_CA <- st_read(huc_gpkg_path, layer = 'WBDHU8') 
huc6_CA <- st_read(huc_gpkg_path, layer = 'WBDHU6')

## Waterbodies
lakes_CA <- st_read(wtbdy_gpkg_path, layer = 'NHDWaterbody') |> 
  st_make_valid()

lakes_in_CA_hucs <- st_join(lakes_CA, huc6_CA) |>
  ## filtering out NA HUC6 because this ensures that we only have Lakes within the CA Huc6 boundaries
  filter(!is.na(HUC6),
  ## rm-ing NA AreaSqKM
  !is.na(AreaSqKM.x))

```

### 2. Fetch geospatial data for Lake Tahoe Basin
_code hidden_
```{r LT_data_pull, include=FALSE, warning=FALSE, message=FALSE}

# NHDPLUS Tools data - Lake Tahoe subset ----------------------------------

# HUC
Lake_Tahoe_huc6 <- filter(huc6_CA, Name == 'Truckee') 
Lake_Tahoe_huc8 <- filter(huc8_CA, Name == 'Lake Tahoe')

# Water features
LT_lakes <- st_join(lakes_in_CA_hucs , Lake_Tahoe_huc8) |>
  filter(!is.na(HUC8))

LT_flines <- get_nhdplus(AOI = Lake_Tahoe_huc8,
                         realization = 'flowline',
                         streamorder = 1)

# NWIS Gages --------------------------------------------------------------

# ID Active NWIS Sites in LT Basin

## ID active sites from last 90 days (dv)
prev90days <- Sys.Date() - 90
active_sites_data_2023 <- readNWISdata(huc = Lake_Tahoe_huc8$HUC8,
                                       service = "iv",
                                       parameterCd = "00060",
                                       startDate = prev90days)

## Vector of currently active sites
active_sites_2023 <- unique(active_sites_data_2023$site_no)

active_nwis_sites_lake_tahoe <- get_nwis(AOI = Lake_Tahoe_huc8,
                                         t_srs = NULL,
                                         buffer = 0) |>
  filter(site_no %in% active_sites_2023)

```

#### Obs. LT spatial data in mapview
_code hidden_
```{r looking_at_spatial_data_w_mapview, echo = FALSE,  warning=FALSE, message=FALSE}

# Quick Mapview -----------------------------------------------------------

## VIZ
mapview(LT_flines, color = 'darkblue')+
  mapview(LT_lakes, col.regions = 'darkblue')+
  mapview(active_nwis_sites_lake_tahoe, col.regions = 'red')+
  mapview(Lake_Tahoe_huc8, col.regions = NA, color = 'black', alpha.regions = 0)

```


### 3. Map Plotting
```{r LT_map, warning=FALSE, message=FALSE}

# Viz Variables -----------------------------------------------------------

map_bbox <- st_bbox(Lake_Tahoe_huc8)
# extract colors form image
colors <- get_colors(img='in/R/lake-tahoe-1591339_1280.jpeg')
# create palette, default palette size is 10
colours_vector <- make_palette(colors)

# Main map -----------------------------------------------------------

lt_map <- ggplot()+
  ## State boundaries
   geom_sf(data = West_sf,
           fill = 'white',
           color = 'grey',
           alpha = 0.1,
           size = 0.5)+
  ## lakes (incl. all lakes in basin)
   geom_sf(data = LT_lakes,
           fill = colours_vector[4], 
           color = colours_vector[4],
           alpha = 0.8)+
  ## huc8 boundary of basin
   geom_sf(data = Lake_Tahoe_huc8,
           fill = 'transparent',
           color = 'firebrick',
           size = 0.8,
           linetype = 'dotted')+
  ## Basin flowlines
   geom_sf(data = LT_flines,
           color = colours_vector[4],
           size  = 0.5,
           alpha = 0.7)+
  ## nwis st stations around LT
   geom_sf(data = active_nwis_sites_lake_tahoe,
           color = 'darkolivegreen2',
           fill = '#3D8361',
           size = 2, 
           shape = 21)+
  ## station labels
   geom_text_repel(data = active_nwis_sites_lake_tahoe,
                  color = 'black',
                aes(label = site_no,
                    geometry = geometry),
                stat = "sf_coordinates",
    min.segment.length = 1,
    size =3,
    nudge_x = 0.05,
    point.padding = 1e-04)+
   coord_sf(
     ylim = c(map_bbox$ymin, map_bbox$ymax),
     xlim = c(map_bbox$xmin, map_bbox$xmax)
     )+
   theme_classic()+
  ## adding state labels at top of map
  annotate('text', x = -120.10, y = 39.34, label = c('California'),
           hjust = 'left', size = 3, fontface = 'italic',  colour = 'grey')+
  annotate('text', x = -119.95, y = 39.34, label = c('Nevada'),
           hjust = 'left', size = 3, fontface = 'italic', colour = 'grey')

lt_map
## using generic save_map function to generate final map (in 'src/funs.R')
lt_map_for_viz <- final_map_formatting(lt_map,
                                   out_file = 'out/LT_map_gauges.png')

```


## B. Workflow for lineplots

### 1. Extract and Process Gauge Data for plots
_code hidden_
```{r pull_nwis_data, include= FALSE, warning= FALSE, message=FALSE}

# Pull all NWIS data for active sites

## check the site history
view_data_summary <- readNWISstat(siteNumbers = active_sites_2023,
                                  parameterCd="00060",
                                  statReportType="annual",
                                  statType="mean") |>
  group_by(site_no,year_nu) |>
  summarize(n()) |>
  arrange(year_nu)

# What sort of data is avail at sites
dailyDataAvailable <- whatNWISdata(
  siteNumber = active_sites_2023,
  service = 'dv') |>
  select(site_no, station_nm, data_type_cd, parm_cd, begin_date, end_date)

## Get Data with readNWISdv 
LT_dv_data <- readNWISdv(siteNumbers = active_sites_2023,
           parameterCd = '00060') |> 
  renameNWISColumns()

## IV data ? 
# readNWISdata(site_no = active_sites_2023, service = 'iv')

```

### 2. Process flow data
_code hidden_
```{r flow_data_processing, include= FALSE, warning= FALSE, message=FALSE}

# Dates --------------------------------------------------------------

LT_dv_data_dates <- LT_dv_data |>
  ## keeping year numeric to enable filter
  mutate(year = year(Date),
         month = month(Date, label = T),
         day = day(Date),
         day_of_week = lubridate::wday(Date, label = T),
         ## grabing month_day only, as I hope this can be the X axis - however this is not considered Date format. 
         month_day = format(Date,"%m-%d"),
         fake_date = as.Date(paste0('2020-',month_day))
         )

# Moving Avg --------------------------------------------------------------

# Calc Moving average Values into a new column
LT_dv_data_w_MA <- LT_dv_data_dates |>
  ## calc MA with zoo::rollmean() . Check what k (2nd param) is for 
  mutate(MA = rollmean(Flow, 2, na.pad = T, align = 'right'))

# Focus on Spring flow ----------------------------------------------------

LT_dv_data_viz <- LT_dv_data_w_MA |> 
  ## all sites have data up until april 15 (one does have data passed that)
#  filter(Date < 2023-04-15) |> 
  filter(month %in% c('Mar','Apr','May'),
#         year %in% c(2020,2021,2022,2023),
        day_of_week %in% c('Mon','Wed','Fri')
         ) |> group_by(site_no)

```

### 3. Generate Lineplots
```{r flow_data_line_plot, warning=FALSE, message=FALSE, results = 'hide'}


## generate line plots
## Note - function pulled from 'src/funs.R'
line_plot_lst <- LT_dv_data_viz |>
  group_map( ~time_series_plot(data = .x,
                               x_var = 'fake_date', ## note - created a fake date with same year to get each year as different line
                               y_var = 'MA',
                               date_range =  c('1975-01-01', '2023-04-15'),
                               title = sprintf('Site Number: %s', site),
                               top_year_num = 4,
                               out_folder = 'out',
                               ## NEED HELP WITH COLORS
                               color_palette = RColorBrewer::brewer.pal(9, 'BrBG')),
             keep = TRUE) ## note - setting keep = TRUE ensure group col is kept.

setNames(line_plot_lst, unique(LT_dv_data_viz$site_no))

line_plot_grid_1 <- cowplot::plot_grid(plotlist = line_plot_lst[1:5])
line_plot_grid_2 <-cowplot::plot_grid(plotlist = line_plot_lst[6:10])

ggsave(plot = line_plot_grid_1, filename = 'out/line_plot_grid_1.png', width = 9, height = 9, dpi = 300)
ggsave(plot = line_plot_grid_2, filename = 'out/line_plot_grid_2.png', width = 9, height = 9, dpi = 300)

```

### Final Viz Pieces

1. lt_map_for_viz
2. line_plot_lst

```{r plots, warning = FALSE, message = FALSE}

lt_map_for_viz
line_plot_grid_1
line_plot_grid_2

```



## Formatting

```{r plotting_vars}

# Load some custom fonts and set some custom settings
font_legend <- "Pirata One"
sysfonts::font_add_google("Pirata One")
supporting_font <- "Source Sans Pro"
sysfonts::font_add_google("Source Sans Pro")
showtext::showtext_opts(dpi = 300, regular.wt = 200, bold.wt = 700)
showtext::showtext_auto(enable = TRUE)

# Define colors
background_color = "#F6F1E9"
font_color = "#ffffff"

# The background canvas for your viz
canvas <- grid::rectGrob(
  x = 0, y = 0, 
  width = 16, height = 9,
  gp = grid::gpar(fill = background_color, alpha = 1, col = background_color)
)

# Load in USGS logo (also a black logo available)
usgs_logo <- magick::image_read("../usgs_logo_white.png") 


```

Arrange line plots 

```{r cowplotting_line_plots}

Ymargin <- 0.04
Xmargin <- 0.04
Xbase <- 1-Xmargin # from right
Ybase <- Ymargin*2 # from bottom
Yjitter <- (0.40 - 2*Ymargin)/2
Xjitter <- (1 - 2*Xmargin)/5 # total jitter
Xwidth <- 0.15

## Note - purrr must be placed ahead of map otherwise the loop won't work (`coerce of type `closure` error`)
draw_line_plots <- purrr::map(1:length(line_plot_lst), function(x){
                         
                  #       1:length(line_plot_lst)
                         # print(x)
                         # print(paste0('line plot #', x))

                         # X axis positioning on the two sides of LT Map 
                         if(x %in% seq(1,5)){
                             X_position <- Xmargin + Xjitter  # 0.224
                             } else {
                               X_position <- Xbase # 0.96
                             } 
                         
                         # Y axis positioning from top to bottom
                         if(x %in% c(1,6)){
                           Y_position <- Ybase + (4*Yjitter) # 0.72
                        } else if(x %in% c(2,7)){
                           Y_position <- Ybase + (3*Yjitter)  # 0.56
                        } else if(x %in% c(3,8)){
                           Y_position <- Ybase + (2*Yjitter)  # 0.4
                        } else if(x %in% c(4,9)){
                           Y_position <- Ybase + (1*Yjitter) # 0.24
                        } else {
                             Y_position <- Ybase
                        }
                       
                       # print(paste0('X_position = ', X_position))
                       # print(paste0('Y_position = ', Y_position))

                       draw_plot(line_plot_lst[[x]],
                                 x = X_position,
                                 y = Y_position,
                                 hjust = 1,
                                 height = Yjitter,
                                 width = Xjitter) 

})


```


## C. Produce final plot

Here, use `cowplot` and `ggsave` to create the final viz for sharing out on Twitter. This template includes adding the USGS logo, title, text, etc.

```{r cowplot, fig.width = 16, fig.height = 9, warning=FALSE, message=FALSE}


ggdraw(ylim = c(0,1), # 0-1 scale makes it easy to place viz items on canvas
       xlim = c(0,1)) +
  # a background
  draw_grob(canvas,
            x = 0, y = 1,
            height = 9, width = 16,
            hjust = 0, vjust = 1) +
  # the main plot
  draw_line_plots +
  draw_plot(lt_map_for_viz,
            x = 0.01,
            y = 0.01,
            height = 1,
            width = 1, scale = 0.8) +
  # explainer text
  draw_label("Explainer text",
             fontfamily = supporting_font,
             x = 0.96,   
             y = 0.05,
             size = 12,
             hjust = 1,
             vjust = 0,
             color = font_color)+
  # Title
  draw_label("Title",
             x = 0.04,
             y = 0.285,
             hjust = 0,
             vjust = 1,
             lineheight = 0.75,
             fontfamily = font_legend,
             color = font_color,
             size = 55) +
  # Add logo
  draw_image(usgs_logo, 
             x = 0.04,
             y = 0.05,
             width = 0.1, 
             hjust = 0, vjust = 0, 
             halign = 0, valign = 0)

# Save the final image in Twitter's 16 by 9 format
# !! Use format for saving with the date of your prompt: 
#         YYYYMMDD_prompt_name ()
# e.g. `20230101_part-to-whole-cnell.png`
ggsave(filename = "out/20230428_trends_msleckman.png", 
       width = 16, height = 9, dpi = 300)
```

## Supporting information

### Key takeaways of this viz (1-2 sentences each)

2023 is a record snowpack year for the Lake Tahoe basin, and with that, a record snowmelt year.
This viz is meant to highlight how the 2023 streamflow into the Lake Tahoe compares, thus far, to the top flow years. 

1. Key takeaways here
tbd

### Data source(s)

NHDPlus High Resolution - geospatial dataset capturing water basins and flow of water across the Nation's landscapes. https://www.usgs.gov/national-hydrography/nhdplus-high-resolution

USGS National Water Information System - water data collected at water gauges.
https://waterdata.usgs.gov/nwis/rt


