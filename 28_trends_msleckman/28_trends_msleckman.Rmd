---
title: "28 Trends - How much Water is entering Lake Tahoe?"
author: "Margaux Sleckman"
date: "2023-03-10"
output: html_document
---

## SET UP

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## currently empty
source('src/funs.R')

```

```{r libraries, warning=FALSE, message=FALSE}
# Load libraries
library(tidyverse) # includes ggplot
library(readr) # best for reading and writing csvs
library(lubridate)
library(glue)
library(zoo)
library(sf)
library(mapdata)
library(maps)
library(spData)

library(nhdplusTools)
library(dataRetrieval)

# These are used for the layout of the viz
library(cowplot) # for laying out the final plot
library(sysfonts) # for text editing
library(showtext) # for adding in google fonts
library(magick) # for adding logo
library(mapview) # for interactive map viz

```

```{r options}

options(tidyverse.quiet = TRUE, timeout = 500)
mapviewOptions(fgb = FALSE)

## Creating local folders for add
dir.create('in/R', showWarnings = F)
dir.create('in/R/nhdPlusTools', showWarnings = F)

```


## A. Workflow for Map 
### 1. Fetching nhdplus spatial data w/ nhdplustools

```{r generic_nhdPlus_data_fetch}

# state boundaries --------------------------------------------------------

CA_sf <- us_states |> filter(NAME == 'California')
West_sf <- us_states |> filter(NAME %in% c('California','Oregon',
                                           'Nevada','Utah',
                                           'Arizona',
                                           'Idaho','Washington'))

# AOI for NHD data extraction ---------------------------------------------

## grab huc 8s with nhdplus tools
CA_huc8 <- nhdplusTools::get_huc8(AOI = CA_sf)

## define all huc4 to allow data download
CA_huc4 <- CA_huc8$huc8 |> substr(1,4) |> unique()

# NHD Data Download (conditional Run only if not downloaded yet) ----------------------------------

if(is.null(list.files('in/R/nhdPlusTools'))){
  
  print(paste('Downloading NHD data for the following CA HUC4s',CA_huc4))

  download_nhdplushr('in/', CA_huc4)
}

huc_gpkg_path <- 'in/R/nhdPlusTools/nhdplustools_HU_CA_data.gpkg'
wtbdy_gpkg_path <- 'in/R/nhdPlusTools/nhdplustools_CA_wtrbdy_data.gpkg'

if(is.null(list.files('in/R/nhdPlusTools', full.names = T, pattern = '_data.gpkg'))){
  # Store HUCs shps into geopackage
  print(paste('... Storing HUCs shps into a local geopackage here:', huc_gpkg_path))
  nhdplusTools::get_nhdplushr(hr_dir = 'in/R/nhdPlusTools/',
                              out_gpkg = huc_gpkg_path,
                              layer = c('WBDHU6','WBDHU8', 'WBDHU10'))

  # Store Waterbodies shps into geopackage
  print(paste('... Storing Waterbody shps into a local geopackage here:', wtbdy_gpkg_path))
  nhdplusTools::get_nhdplushr(hr_dir = 'in/R/nhdPlusTools/',
                              out_gpkg = 'in/R/nhdplustools_CA_wtrbdy_data.gpkg',
                              layer = 'NHDWaterbody')

  # # Store Waterbodies shps into geopackage
  # # This one takes A-WHILE so defaulted to using nhdplustools::get_flines()
  # nhdplusTools::get_nhdplushr(hr_dir = 'in/R/nhdPlusTools/',
  #                            out_gpkg = 'in/R/nhdplustools_CA_flines_data.gpkg',
  #                            layer = 'NHDFlowline')

  }
  
## Display Layers
print(st_layers(huc_gpkg_path))
print(st_layers(wtbdy_gpkg_path))

# Load nhdPlus features for AOI ----------------------------------------------------------------
## HUCS
huc10_CA <- st_read(huc_gpkg_path, layer = 'WBDHU10')
huc8_CA <- st_read(huc_gpkg_path, layer = 'WBDHU8') 
huc6_CA <- st_read(huc_gpkg_path, layer = 'WBDHU6')

## Waterbodies
lakes_CA <- st_read(wtbdy_gpkg_path, layer = 'NHDWaterbody') |> 
  st_make_valid()

lakes_in_CA_hucs <- st_join(lakes_CA, huc6_CA) |>
  ## filtering out NA HUC6 because this ensures that we only have Lakes within the CA Huc6 boundaries
  filter(!is.na(HUC6),
  ## rm-ing NA AreaSqKM
  !is.na(AreaSqKM.x))

```

### 2. Fetch geospatial data for Lake Tahoe Basin

```{r LT_data_pull}

# NHDPLUS Tools data - Lake Tahoe subset ----------------------------------

# HUC
Lake_Tahoe_huc6 <- filter(huc6_CA, Name == 'Truckee') 
Lake_Tahoe_huc8 <- filter(huc8_CA, Name == 'Lake Tahoe')

# Water features
LT_lakes <- st_join(lakes_in_CA_hucs , Lake_Tahoe_huc8) |>
  filter(!is.na(HUC8))

LT_flines <- get_nhdplus(AOI = Lake_Tahoe_huc8,
                         realization = 'flowline',
                         streamorder = 1)

# NWIS Gages --------------------------------------------------------------

# ID Active NWIS Sites in LT Basin

## ID active sites from last 90 days (dv)
prev90days <- Sys.Date() - 90
active_sites_data_2023 <- readNWISdata(huc = Lake_Tahoe_huc8$HUC8,
                                       service = "iv",
                                       parameterCd = "00060",
                                       startDate = prev90days)

## Vector of currently active sites
active_sites_2023 <- unique(active_sites_data_2023$site_no)

active_nwis_sites_lake_tahoe <- get_nwis(AOI = Lake_Tahoe_huc8,
                                         t_srs = NULL,
                                         buffer = 0) |>
  filter(site_no %in% active_sites_2023)

```

#### Obs. LT spatial data in mapview

```{r looking_at_spatial_data_w_mapview}

# Quick Mapview -----------------------------------------------------------

## VIZ
mapview(LT_flines, color = 'darkblue')+
  mapview(LT_lakes, col.regions = 'darkblue')+
  mapview(active_nwis_sites_lake_tahoe, col.regions = 'red')+
  mapview(Lake_Tahoe_huc8, col.regions = NA, color = 'black', alpha.regions = 0)

```


### 3. Map Plotting
```{r LT_map}

# Viz Variables -----------------------------------------------------------

map_bbox <- st_bbox(Lake_Tahoe_huc8)

# Main Map
lt_map <- ggplot()+
   geom_sf(data = West_sf, fill = 'white', color = 'grey', alpha = 0.1, size = 0.5)+
   geom_sf(data = LT_lakes, fill = '#3792cb', color = '#3792cb', alpha = 0.8)+
   geom_sf_text(data = West_sf, color = 'grey', aes(label = NAME),
                size =2, fontface = 'italic', nudge_x = 0.1) +
   geom_sf(data = Lake_Tahoe_huc8, fill = 'transparent', color = 'firebrick', size = 0.8, linetype = 'dotted')+
   geom_sf(data = LT_flines, color = '#3792cb', size  = 0.5, alpha = 0.6)+
   geom_sf(data = active_nwis_sites_lake_tahoe,
           aes(geometry = geometry),
           color = '#006200',
           size = 1.3, alpha = 0.9)+
   geom_sf_text(data = active_nwis_sites_lake_tahoe, color = 'black',
                aes(label = site_no), size =3, nudge_x = 0.05)+
   coord_sf(ylim = c(map_bbox$ymin, map_bbox$ymax),
            xlim = c(map_bbox$xmin, map_bbox$xmax))+
   theme_classic()

## using generic save_map function to generate final map
lt_map_for_viz <- save_map(lt_map, out_file = 'out/LT_map_gauges.png')
 
```


## B. Workflow for lineplots

### 1. Extract and Process Gauge Data for plots
```{r pull_nwis_data}

# Pull all NWIS data for active sites

## check the site history
view_data_summary <- readNWISstat(siteNumbers = active_sites_2023,
                                  parameterCd="00060",
                                  statReportType="annual",
                                  statType="mean") |>
  group_by(site_no,year_nu) |>
  summarize(n()) |>
  arrange(year_nu)

# What sort of data is avail at sites
dailyDataAvailable <- whatNWISdata(
  siteNumber = active_sites_2023,
  service = 'dv') |>
  select(site_no, station_nm, data_type_cd, parm_cd, begin_date, end_date)

## Get Data with readNWISdv 
LT_dv_data <- readNWISdv(siteNumbers = active_sites_2023,
           parameterCd = '00060') |> 
  renameNWISColumns()

## IV data ? 
# readNWISdata(site_no = active_sites_2023, service = 'iv')

```

### 2. Process flow data
```{r flow_data_processing}

# Dates --------------------------------------------------------------

LT_dv_data_dates <- LT_dv_data |>
  ## keeping year numeric to enable filter
  mutate(year = year(Date),
         month = month(Date, label = T),
         day = day(Date),
         day_of_week = lubridate::wday(Date, label = T),
         ## grabing month_day only, as I hope this can be the X axis - however this is not considered Date format. 
         month_day = format(Date,"%m-%d"),
         fake_year = as.Date(paste0('2020-',month_day))
         )

# Moving Avg --------------------------------------------------------------

# Calc Moving average Values into a new column
LT_dv_data_w_MA <- LT_dv_data_dates |>
  ## calc MA with zoo::rollmean() . Check what k (2nd param) is for 
  mutate(MA = rollmean(Flow, 2, na.pad = T, align = 'right'))

# Focus on Spring flow ----------------------------------------------------

LT_dv_data_viz <- LT_dv_data_w_MA |> 
  ## all sites have data up until april 15 (one does have data passed that)
#  filter(Date < 2023-04-15) |> 
  filter(month %in% c('Mar','Apr','May'),
#         year %in% c(2020,2021,2022,2023),
        day_of_week %in% c('Mon','Wed','Fri')
         ) |> group_by(site_no)

```

### 3. Generate Lineplots
```{r flow_data_line_plot}

line_plot_lst <- LT_dv_data_viz |>
  group_map( ~time_series_plot(data = .x,
                               x_var = 'fake_year',
                               y_var = 'MA',
                               date_range =  c('1975-01-01', '2023-04-15'),
                               top_year_num = 4, out_folder = 'out'),
             keep = TRUE) ## note - setting keep = TRUE ensure group col is kept.


line_plot_grid_1 <- cowplot::plot_grid(plotlist = line_plot_lst[1:5])
line_plot_grid_2 <-cowplot::plot_grid(plotlist = line_plot_lst[6:10])

ggsave(plot = line_plot_grid_1, filename = 'out/line_plot_grid_1.png', width = 9, height = 9, dpi = 300)
ggsave(plot = line_plot_grid_2, filename = 'out/line_plot_grid_2.png', width = 9, height = 9, dpi = 300)

lt_map_for_viz
```

**PLOTS are: **

1. lt_map_for_viz
2. line_plot_lst

This chunk is where the main ggplot grob definition and set-up occurs. You may have several ggplot grobs, depending on your approach. For each one, if you define it with the `<-` assignment operator and surround the whole code statement in parentheses, you'll be able to preview here what the plot looks like before the next cowplot step.

> Note: The hardest part of this process is getting text to be the optimum size in the final `png` for Twitter. The font sizes here will **not** be the same as in the final image after the cowplot step. Make sure to check the output `png` for true font sizing and plot composition. 

```{r plotting_vars}

# Load some custom fonts and set some custom settings
font_legend <- "Pirata One"
sysfonts::font_add_google("Pirata One")
supporting_font <- "Source Sans Pro"
sysfonts::font_add_google("Source Sans Pro")
showtext::showtext_opts(dpi = 300, regular.wt = 200, bold.wt = 700)
showtext::showtext_auto(enable = TRUE)

# Define colors
background_color = "#0A1927"
font_color = "#ffffff"

# The background canvas for your viz
canvas <- grid::rectGrob(
  x = 0, y = 0, 
  width = 16, height = 9,
  gp = grid::gpar(fill = background_color, alpha = 1, col = background_color)
)

# Load in USGS logo (also a black logo available)
usgs_logo <- magick::image_read("../usgs_logo_white.png") 


```


## C. Produce final plot

Here, use `cowplot` and `ggsave` to create the final viz for sharing out on Twitter. This template includes adding the USGS logo, title, text, etc.

```{r cowplot, fig.width = 16, fig.height = 9}

ggdraw(ylim = c(0,1), # 0-1 scale makes it easy to place viz items on canvas
       xlim = c(0,1)) +
  # a background
  draw_grob(canvas,
            x = 0, y = 1,
            height = 9, width = 16,
            hjust = 0, vjust = 1) +
  # the main plot
  draw_plot(line_plot,
            x = 0.01,
            y = 0.01,
            height = 1) +
  # explainer text
  draw_label("Explainer text",
             fontfamily = supporting_font,
             x = 0.96,   
             y = 0.05,
             size = 14,
             hjust = 1,
             vjust = 0,
             color = font_color)+
  # Title
  draw_label("Title",
             x = 0.04,
             y = 0.285,
             hjust = 0,
             vjust = 1,
             lineheight = 0.75,
             fontfamily = font_legend,
             color = font_color,
             size = 55) +
  # Add logo
  draw_image(usgs_logo, 
             x = 0.04,
             y = 0.05,
             width = 0.1, 
             hjust = 0, vjust = 0, 
             halign = 0, valign = 0)

# Save the final image in Twitter's 16 by 9 format
# !! Use format for saving with the date of your prompt: 
#         YYYYMMDD_prompt_name ()
# e.g. `20230101_part-to-whole-cnell.png`
ggsave(filename = "out/20230428_trends_msleckman.png", 
       width = 16, height = 9, dpi = 300)
```

## Supporting information

### Key takeaways of this viz (1-2 sentences each)

1. Key takeaways here

### Data source(s)

Data sources here.

