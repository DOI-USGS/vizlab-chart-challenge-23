---
title: "Many Water Levels of Lake Powell"
author: "Caitlin M Andrews"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, warning=FALSE, message=FALSE}
# Load libraries
library(geomtextpath)
library(ggsci)
library(ggthemes)
library(paletteer)
library(scales)

library(DBI)
library(odbc)
library(lubridate)
library(data.table)
library(tidyr)

# These are used for the layout of the viz
library(cowplot) # for laying out the final plot
library(sysfonts) # for text editing
library(showtext) # for adding in google fonts
library(magick) # for adding logo
```

```{r plotting and theme settings, echo = FALSE}

# font -------------------------------------------------------------------------
showtext_opts(dpi = 300)
showtext_auto()
font_add_google("Signika", "Signika")

theme_set(theme_light(base_size = 17, base_family = "Signika"))

geom.text.size = 4.4
theme.size = (14/5) * geom.text.size
update_geom_defaults("text", list(size = geom.text.size, family = 'Signika'))

# color scales -----------------------------------------------------------------
#paletteer_c("ggthemes::Sunset-Sunrise Diverging", 30)
paletteer_d("colorBlindness::paletteMartin")
show_col(pal_uchicago("default")(9))
my_point_pal <- c("#b72e74","#74b72e", "#7f45b4",
                    "#8A9045FF", "#155F83FF", "#767676FF")


```


```{r generate or read in data, echo=FALSE}
referenceHeight <- 3520 # Recent Height 

# bathymetry -------------------------------------------------------------------
bath <- read.csv('in/elevation_profile.csv')
names(bath) <- c('distanceFromDam', 'elevation')
bath$distanceFromDam <- bath$distanceFromDam * 3.28084
bath$distanceFromDamMiles <- bath$distanceFromDam * 0.000189394
bath$elevation <- bath$elevation * 3.28084
bath$lakedepth <- referenceHeight - bath$elevation


# dam things -------------------------------------------------------------------
damHeights <- data.frame(name = c('Spillways', 'Penstock Depth', 'River Bypass'),
                         description = c('Spillways\n3648 ft',
                                         ' Intake for Power\n3470 ft',
                                         'River Bypass\n3374 ft'),
                         description2 = c('  Spillways', '', ' River Bypass'),
                         description3 = c('', '    Intakes\nfor Power', ''),
                         elevation = c(3648, 3470, 3370))

damHeights$distance <- (referenceHeight - damHeights$elevation)
damHeights$name <- factor(damHeights$name, levels = c('Spillways', 'Penstock Depth', 'River Bypass'))

# lake elevations --------------------------------------------------------------
lakeElevations <- data.frame(name = c('1983 Flood', 'Current (April 2023)', 
                                      '2005 Drought'),
                             elevationL = c(3715, 3520, 3555))
lakeElevations$distanceL <- referenceHeight - lakeElevations$elevationL


# key functional elevations   --------------------------------------------------
funcElevations <- data.frame(name = c( 'Full Pool',  'Minimum Power Pool', 'Dead Pool'),
                             x = c(70, 55, 38),
                             description2 = c('Full Pool',
                                              '', ''),
                             description3 = c('',
                                              'Minimum\nPower Pool',
                                              ''),
                             description4 = c('',
                                              '',
                                              'Dead Pool'),
                             elevation = c(3700, 3490, 3365 ))
funcElevations$distance <- referenceHeight - funcElevations$elevation


```

```{r plotting setup, echo=FALSE}
g1 <- 
  ggplot() + 
  scale_color_manual(values = my_point_pal) +
  scale_fill_manual(values = my_point_pal) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0, max(bath$distanceFromDamMiles)),
                     breaks = c(seq(0, 150, 50)))  +
  scale_y_continuous(expand = c(0,0), 
                     limits = c(3100, 3725),
                     breaks = c(),
                     labels =c(),
                     # # Add a second axis a
                     sec.axis = dup_axis(
                       breaks = c( 3700, referenceHeight, 3490, 3365),
                       labels = c(3700, referenceHeight, 3490, 3330)),
                     name = 'Elevation above Sea Level (feet)') +
  labs(x = 'Colorado River Channel Miles from Glen Canyon Dam') +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    axis.title=element_text(size = 14),
    panel.border = element_blank()
    #plot.background = element_rect(fill = "#fbdbc9")
  ) 

```

```{r plot!}
Fig1 <- g1 + 
  
  # ----- agua -----------------------------------------------------------------
  geom_ribbon(data = bath,
              aes(x= distanceFromDamMiles, 
                  ymin = referenceHeight, ymax = elevation),
              fill = '#b0efef') +
  
  # key functional elevations ----- points and lines from reference ------------
  geom_texthline(data = funcElevations,
             aes(yintercept = elevation, label = name, color = name, 
                 hjust = name), 
             size = geom.text.size -.1, lty = 'dashed', 
             fontface = 'bold') +
  scale_hjust_manual(values = c(.27, .46, .42)) +
  geom_segment(data = funcElevations,
               aes(x = x, y = elevation, xend = x, yend = referenceHeight,
               color = name), linewidth = 1.1) +
  geom_point(data = funcElevations,
             aes(x = x, y = elevation, fill = name),
             size = 4, pch = 21) +
  
  # lake elevations ------------------ solid blue horizontal lines -------------
  geom_texthline(data = lakeElevations,
                 aes(yintercept = elevationL, label = name,
                     linewidth = name),
               color = '#07659b', hjust = .67, fontface = 'bold', 
               size = geom.text.size ) +
  scale_linewidth_manual(values = c(.5,.5, 2)) +
  
  # dam points ---------------- ▶ ----------------------------------------------
  geom_text(data = damHeights,
            aes(x = 0, y = elevation, color = name),
            label = " ▶",  size = 12, family = "wqy-microhei")  +
  geom_text(data = damHeights,
            aes(x = 0, y = elevation, color = name, label = description3),
            hjust = -.2, vjust = .5, fontface = 'bold')  +
  geom_text(data = damHeights,
            aes(x = 0, y = elevation, color = name, label = description2),
            hjust = -.2, vjust = 0.3, fontface = 'bold')  +
  
  # bathymetry  ----------------------------------------------------------------
  geom_ribbon(data = bath,
              aes(x= distanceFromDamMiles, ymin = 3100, 
                  ymax = elevation),
              fill = '#814231')  +
  geom_line(data = bath,
          aes(x = distanceFromDamMiles, y = elevation),
           size = 2.5, color = '#eab676') 

```

```{r add text to plot!, fig.path="/out"}
# This is so ugly!!
# text -------------------------------------------------------------------------
txt1 <- "Current Status:"

txt2 <- paste0("• ", "Distance to full pool:")
txt22 <- paste0(180, " vertical feet in")
txt23 <- paste0(" elevation and ", 24, " million acre feet (maf) by")
txt24 <- "volume."

txt3 <- paste0("• ", "Distance to minimum power pool:")
txt32 <- paste0(30)
txt33 <- paste0(" vertical feet and ", 4, " maf.") 

txt4 <-   paste0("• ", "Distance to dead pool:")
txt42 <-  paste0(150, " vertical feet")
txt43 <-  paste0("and ", 5.6, " maf.")


Fig1.2 <- Fig1 + annotate("text", x = 95, y = 3310, label = txt1, color = 'white', 
                          hjust = 0, size = geom.text.size + .75) +
  
  annotate("text", x = 95, y = 3270, label = txt2, color = "#74b72e",  
           fontface = 'bold', hjust = 0, size = geom.text.size + .5) +
  annotate("text", x = 139, y = 3270, label = txt22, color = 'white',  
           hjust = 0, size = geom.text.size + .3) + 
  annotate("text", x = 97, y = 3245, label = txt23, color = 'white',  
           hjust = 0, size = geom.text.size + .3) + 
  annotate("text", x = 98, y = 3220, label = txt24, color = 'white',  
           hjust = 0, size = geom.text.size + .3) + 
  
  annotate("text", x = 95, y = 3190, label = txt3, color = '#C59AFA', 
            fontface = 'bold', hjust = 0, size = geom.text.size + .5) + 
  annotate("text", x = 163, y = 3190, label = txt32, color = 'white',
           hjust = 0, size = geom.text.size + .3) + 
  annotate("text", x = 97, y = 3170, label = txt33, color = 'white',
           hjust = 0, size = geom.text.size + .3) + 
   
  annotate("text", x = 95, y = 3140, label = txt4, color = '#F25278',
         fontface = 'bold', hjust = 0, size = geom.text.size + .5) +
  annotate("text", x = 141.5, y = 3140, label = txt42, color = 'white',  
          hjust = 0, size = geom.text.size + .3) + 
  annotate("text", x = 97, y = 3120, label = txt43, color = 'white',
           hjust = 0, size = geom.text.size + .3) 

ggsave(filename = paste0('20230419_anthropocene_andrews_base.png'), 
       path = 'out/',
       width = 9,
       height = 7,
       unit = 'in',
       dpi = 300)

# added title, logo, text and illustration in powerpoint and exported to png.
```