---
title: "When is drought?"
author: "Althea Archer"
date: "2023-03-10"
output: html_document
---



## Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
```



Define libraries here. 

```{r libraries, warning=FALSE, message=FALSE}
# Load libraries
library(tidyverse) # includes ggplot
library(readr) # best for reading and writing csvs

library(sbtools)
library(lubridate)
library(sf)
library(spData)

# These are used for the layout of the viz
library(cowplot) # for laying out the final plot
library(sysfonts) # for text editing
library(showtext) # for adding in google fonts
library(magick) # for adding logo
```



## Load files

Save any files that you are using directly in the `in` folder. Then read them in to the environment with this chunk of code. Remember, use the RStudio project and relative file pathways, and never include any personal computer file pathways.

This is also a good place to load any data from other built-in packages such as `dataRetrieval` or `spData`, etc.


```{r load}
# Add your code here
# Load drought properties data from ScienceBase
#authenticate_sb() (username includes email address)


# Drought Properties - 7day window - 1951-2020 dataset
drought_properties_7d_file <- "in/Drought_Properties_jd_07d_wndw.csv"
if(!file.exists(drought_properties_7d_file)){ # if files don't exist, download
  sbtools::item_file_download(sb_id = "627974ccd34e8d45aa6e3c81",
                              names = "Drought_Properties_jd_07d_wndw.csv",
                              destinations =  "in/Drought_Properties_jd_07d_wndw.csv",
                              overwrite_file = FALSE)
}
drought_properties_7d <- readr::read_csv(drought_properties_7d_file) 




file_in_metadata <- "in/study_watersheds_metadata.csv"
if(!file.exists(file_in_metadata)){ # if files don't exist, download
  sbtools::item_file_download(sb_id = "62793493d34e8d45aa6e3ba9",
                              names = "study_watersheds_metadata.csv",
                              destinations = file_in_metadata,
                              overwrite_file = F)
}
metadata <- readr::read_csv(file_in_metadata, show_col_types = FALSE) |>
  select(StaID, STANAME, DRAIN_SQKM, HUC02, LAT_GAGE, LNG_GAGE, STATE,
         national_1981, national_1951, national_1921, HCDN_2009)


```

## Get data ready for plotting
  

### Spatial mapping data

```{r spatial}
# Download US State boundaries as sf object
states_sf <- spData::us_states
# add in state names, too
st_crosswalk <- data.frame(NAME = state.name,
                           STATE = state.abb)
# Merge in CASC info
states_CASC <- states_sf |>
  mutate("CASC" = case_when(NAME %in% c("Minnesota", "Iowa", "Missouri", 
                                       "Wisconsin", "Illinois", "Indiana", 
                                       "Michigan", "Ohio") ~ "Midwest",
                          NAME %in% c("Montana", "Wyoming", "Colorado", "North Dakota", 
                                       "South Dakota", "Nebraska", "Kansas") ~ "North Central",
                          NAME %in% c("Maine", "New Hampshire", "Vermont", "Massachusetts", 
                                       "Connecticut", "Rhode Island",
                                       "New York", "New Jersey", "Pennsylvania", 
                                       "Delaware", "Maryland", "West Virginia", 
                                       "Virginia", "Kentucky", "District of Columbia") ~ "Northeast",
                          NAME %in% c("Washington", "Oregon", "Idaho") ~ "Northwest",
                          NAME %in% c("New Mexico", "Texas", 
                                      "Oklahoma", "Louisiana") ~ "South Central",
                          NAME %in% c("North Carolina", "South Carolina", "Georgia", "Alabama", 
                                       "Mississippi", "Florida", "Tennessee", 
                                       "Arkansas") ~ "Southeast",
                          NAME %in% c("Arizona",
                                       "Utah", "Nevada") ~ "Southwest",
                          NAME == "California" ~ "California",
                          TRUE ~ "not sorted")) |>
  left_join(st_crosswalk, by = "NAME")

# convert id to CASC for mapping just regions to make them look "exploded"
mapping_data_regions <- states_CASC |>
  group_by(CASC) |>
  summarise(id = unique(CASC))

# CASC names 
CASC_names <- unique(states_CASC$CASC)
```
  
### Prepping data for when is drought


```{r processing_timing}
# Select appropriate threshold (here 2%)
droughts_2pct <- drought_properties_7d |> 
  # Join metadata 
  left_join(metadata |> select(StaID, STATE), by = "StaID") |>
  # Select 2% threshold
  filter(threshold == 2) |>
  mutate(year = lubridate::year(start)) |>
  # remove couple from 2020 (incomplete year)
  filter(year < 2020) 

droughts_100perYear <- droughts_2pct |>
  # Group by year
  group_by(year) |>
  # and get top 100
  slice_max(order_by = severity, n = 100)


droughts_100_join_CASC <- droughts_100perYear |>
  # Join with CASCs
  mutate(CASC = case_when(STATE %in% c("MN", "IA", "MO", "WI", "IL", "IN", "MI", "OH") ~ "Midwest",
                          STATE %in% c("MT", "WY", "CO", "ND", "SD", "NE", "KS") ~ "North Central",
                          STATE %in% c("ME", "NH", "VT", "MA", "CT", "RI", "DC",
                                       "NY", "NJ", "PA", "DE", "MD", "WV", "VA", "KY") ~ "Northeast",
                          STATE %in% c("WA", "OR", "ID") ~ "Northwest",
                          STATE %in% c("NM", "TX", "OK", "LA") ~ "South Central",
                          STATE %in% c("NC", "SC", "GA", "AL", "MS", "FL", "TN", "AR") ~ "Southeast",
                          STATE %in% c("AZ", "UT", "NV") ~ "Southwest",
                          STATE %in% "CA" ~ "California",
                          TRUE ~ "not sorted"),
         north_south = case_when(CASC %in% c("Northwest", "North Central", "Midwest", "Northeast") ~ "North",
                                 TRUE ~ "South"),
         CASC = factor(CASC, levels = c("California", "Southwest", "South Central", "Southeast",
                                        "Northeast", "Midwest", "North Central", "Northwest")))

# Number of 100 most severe droughts by year in each CASC
table(droughts_100_join_CASC$CASC)
table(droughts_100_join_CASC$north_south)
length(table(droughts_100_join_CASC$STATE))

# Make long
droughts_long <- droughts_100_join_CASC |>
  uncount(duration, .id = "day_of_drought") |>
  # for future munging
  mutate(drought_date = start + day_of_drought -1,
         decade = year(floor_date(start, years(10))),
         year = year(drought_date),
         jd = yday(drought_date),
         drought_day_noYr = format(as.Date(drought_date), "%m-%d"),
         drought_day_fakeYr = as.Date(sprintf("1999-%s", drought_day_noYr), "%Y-%m-%d")) |>
  # make sure they're sorted by date
  arrange(start) |>
  # remove unneeded fields
  select(-threshold, -previous_end, -days_since_previous_drought,
         -has_the_potential_to_be_impacted_by_missing_values) 


```






## Set up global plotting settings

```{r plotting}
# Load some custom fonts and set some custom settings
font_legend <- "Source Sans Pro"
supporting_font <- "Source Sans Pro"
annotation_font <- "Shadows Into Light"
sysfonts::font_add_google("Source Sans Pro")
sysfonts::font_add_google("Shadows Into Light")
showtext::showtext_opts(dpi = 300, regular.wt = 200, bold.wt = 700)
showtext::showtext_auto(enable = TRUE)

# Font sizes
title_size <- 50
support_size <- 24

# Define colors
background_color = "#c2dde6"
font_color = "#431c5d"
base_color = "#634B79"
pop_color = "#e05915"

# The background canvas for your viz
canvas <- grid::rectGrob(
  x = 0, y = 0, 
  width = 16, height = 16,
  gp = grid::gpar(fill = background_color, alpha = 1, col = background_color)
)

# Load in USGS logo (also a black logo available)
usgs_logo <- magick::image_read("../usgs_logo_white.png") 




```

### Making the "when is drought" viz

```{r plot_tests1}
(map_plot <- ggplot(data = states_CASC) +
    geom_sf(fill = base_color, color = background_color, linewidth = 0.5) +
    geom_sf(data = mapping_data_regions, color = background_color, fill = NA, linewidth = 1.5)+
    geom_segment(aes(x = -125, xend = -127, # northwest
                     y = 50, yend = 52), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -101, xend = -101, # north central
                     y = 50, yend = 52), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -85, xend = -75, # midwest
                     y = 48, yend = 52), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -74, xend = -70, # northeast
                     y = 39, yend = 39), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -124, xend = -127, # california
                     y = 37, yend = 37), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -113, xend = -127, # southwest
                     y = 30, yend = 24), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -101, xend = -101, #south central
                     y = 26, yend = 24), 
                 arrow = arrow(length = unit(0.03, "npc")))+
    geom_segment(aes(x = -80, xend = -70, 
                     y = 30, yend = 24), 
                 arrow = arrow(length = unit(0.03, "npc")))+
   theme_void() +
    theme(legend.position = "none")
)
```



```{r plot_tests3}


(CASC_season_plot <- ggplot(data = droughts_long, 
                     aes(x = drought_day_fakeYr, group = desc(decade))) +
   geom_histogram(aes(fill = decade), boundary = 0, bins = 36)+
   facet_wrap(~ CASC)+
   scale_x_date(breaks = "3 month", date_labels = "%b", 
                limits = as.Date(c("1999-01-01", "1999-12-31")),
                expand = c(-0.015,0))+
   labs(fill = "Decade")+
   coord_polar()+
   theme_minimal()+
   ylim(c(0, 2500))+
   scale_fill_viridis_c(end = 0.7, direction = -1)+
   theme(legend.title = element_blank(),
         legend.text = element_text(size = 20,
                                    family = supporting_font),
         legend.key.height = unit(1.5, "cm"),
         legend.key.width = unit(1, "cm"))
 )

legend_seasons <- cowplot::get_legend(CASC_season_plot)
```


```{r casc_seasons}
# Chart settings
Ymargin <-  0.04
Xmargin <- 0.04

# CASC Plots
Xbase <- 1-Xmargin # from right
Ybase <- Ymargin*2 # from bottom
Yjitter <- (0.8 - 2*Ymargin)/3
Xjitter <- (1 - 2*Xmargin)/3

# Function to make regional plots
draw_CASC_plots <- map(1:length(CASC_names), function(x){
  # create temporary plot
  plot_temp <- droughts_long |>
    filter(CASC == CASC_names[x]) |> 
    ggplot(aes(x = drought_day_fakeYr, group = desc(decade))) +
    facet_wrap(~ CASC)+
    geom_histogram(aes(fill = decade), boundary = 0, bins = 36)+
    scale_x_date(breaks = "month", date_labels = "%b", 
                 limits = as.Date(c("1999-01-01", "1999-12-31")),
                 expand = c(-0.015,0))+
    coord_polar()+
    theme_minimal()+
    ylim(c(-500, 2500))+
    scale_fill_viridis_c(end = 0.7, direction = -1)+
    theme(legend.position = "none",
          strip.text = element_text(size = support_size, color = font_color,
                                    family = supporting_font, face = "bold"),
          axis.text = element_blank(),
          axis.title = element_blank())
  
  if(CASC_names[x] %in% c("Southwest", "Southeast", "South Central")){
    Y_position <- Ybase
  } else if(CASC_names[x] %in% c("California", "Northeast")){
    Y_position <- Ybase + Yjitter
  } else {
    Y_position <- Ybase + 2*Yjitter
  }
  
  if(CASC_names[x] %in% c("Northwest", "California", "Southwest")){
    X_position <- Xbase - (2*Xjitter)
  } else if(CASC_names[x] %in% c("North Central", "South Central")){
    X_position <- Xbase - Xjitter
  } else {
    X_position <- Xbase
  } 
  
  draw_plot(plot_temp,
            x = X_position,
            y = Y_position,
            hjust = 1,
            height = Yjitter,
            width = Xjitter) 

})
```

#### Produce final plot


```{r cowplot, fig.width = 16, fig.height = 16}
ggdraw(ylim = c(0,1), # 0-1 scale makes it easy to place viz items on canvas
       xlim = c(0,1)) +
  # a background
  draw_grob(canvas,
            x = 0, y = 1,
            height = 16, width = 16,
            hjust = 0, vjust = 1) +
  # the main plot
  draw_CASC_plots +
  draw_grob(legend_seasons,
            y = Yjitter - 0.05,
            x = 0.5 - Xmargin)+
  draw_plot(map_plot,
            y = 0.44,
            x = 0.5,
            hjust = 0.5,
            vjust = 0.5, 
            width = 0.38) +
  # explainer text
  draw_label("Chart by Althea A Archer. Exceptional droughts defined with 2% variable 7-day thresholds.\nData based on streamflow records from 1831 streamgages: doi.org/10.5066/P92FAASD",
             fontfamily = supporting_font,
             x = 1 - Xmargin,   
             y = Ymargin,
             size = 14,
             hjust = 1,
             vjust = 0,
             color = font_color)+
  # Title
  draw_label("When do droughts happen?",
             x = Xmargin,
             y = 1 - Ymargin,
             hjust = 0,
             vjust = 1,
             lineheight = 1.0,
             fontfamily = font_legend,
             color = font_color,
             size = title_size,
             fontface = "bold") +
  
  # Title
  draw_label("These are the 100 most severe exceptional droughts from each year\nsince 1950 by time of year and decade.",
             x = Xmargin,
             y = 1 - Ymargin - Ymargin ,
             hjust = 0,
             vjust = 1,
             lineheight = 1.0,
             fontfamily = supporting_font,
             color = font_color,
             size = support_size) +
  # Add logo
  draw_image(usgs_logo, 
             x = Xmargin,
             y = Ymargin,
             width = 0.1, 
             hjust = 0, vjust = 0, 
             halign = 0, valign = 0)+
    geom_segment(aes(x = Xbase - Xjitter*2 - 0.153, xend = Xbase - Xjitter*2 - 0.153, 
                     y = Ybase + Yjitter*2 + 0.122, yend = Ybase + Yjitter*2 + 0.2), 
                 arrow = arrow(length = unit(0.01, "npc")),
                 color = pop_color,
             lineend = 'round',
             linewidth = 1.5)+
  draw_text("Number of\ndroughts",
           x = Xmargin + 0.025,
           y = Ybase + Yjitter*3 - 0.08,
           color = pop_color, size = support_size, family = annotation_font,
           hjust = 0)+
  draw_text("Droughts more\n  common January\n   through March",
           x = Xmargin + Xjitter*2 - 0.12,
           y = Ybase + Yjitter*3 - 0.08,
           color = pop_color, size = support_size, family = annotation_font,
           hjust = 0)+
  draw_text("Droughts shifting\nto later\nin year\nsince\n1950s",
           x = Xmargin + Xjitter*2 + 0.028,
           y = Ybase + Yjitter*2 - 0.10,
           color = pop_color, size = support_size, family = annotation_font,
           hjust = 0)+
  geom_curve(aes(xend = Xbase - Xjitter*2 - 0.062, x = Xbase - Xjitter*2 - 0.145,
                 yend = Ybase + Yjitter*2 + 0.115, y = Ybase + Yjitter*2 + 0.2),
             arrow = grid::arrow(length = unit(0.75, 'lines')),
             curvature = -0.40,
             angle = -88,
             color = pop_color,
             lineend = 'round',
             linewidth = 1.5)+
  draw_text("Calendar\n   year",
           x = Xmargin + 0.24,
           y = Ybase + Yjitter*3 - 0.08,
           color = pop_color, size = support_size, family = annotation_font,
           hjust = 0)+
  # Add logo
  draw_text("DRAFT", 
             x = 0.25,
             y = Ymargin,
            color = pop_color, size = title_size)


# Save the final image in Twitter's 16 by 9 format
# !! Use format for saving with the date of your prompt: 
#         YYYYMMDD_prompt_name ()
# e.g. `20230101_part-to-whole-cnell.png`
ggsave(filename = "out/20230423_timeseries-tiles_whenDrought_aaarcher.png", 
       width = 16, height = 16, dpi = 300)
```




## Supporting information

### Key takeaways of this viz (1-2 sentences each)

1. Key takeaways here

### Data source(s)

Data sources here.

